import { Injectable, Inject, isDevMode } from '@angular/core';
import { NGX_GOOGLE_ANALYTICS_SETTINGS_TOKEN } from '../tokens/ngx-google-analytics-settings-token';
import { DOCUMENT } from '@angular/common';
import { NGX_GTAG_FN } from '../tokens/ngx-gtag-token';
import * as i0 from "@angular/core";
import * as i1 from "../tokens/ngx-google-analytics-settings-token";
import * as i2 from "@angular/common";
import * as i3 from "../tokens/ngx-gtag-token";
import * as ɵngcc0 from '@angular/core';
export class GoogleAnalyticsService {
    constructor(settings, _document, _gtag) {
        this.settings = settings;
        this._document = _document;
        this._gtag = _gtag;
    }
    get document() {
        return this._document;
    }
    throw(err) {
        if ((this.settings.enableTracing || isDevMode()) && console && console.error) {
            console.error(err);
        }
    }
    /** @todo Change this to `Object.fromEntity()` in the future... */
    toKeyValue(map) {
        return (map.size > 0)
            ? Array.from(map).reduce((obj, [key, value]) => Object.defineProperty(obj, key, { value, enumerable: true }), {})
            : undefined;
    }
    /**
     * Call native GA Tag
     */
    gtag(...args) {
        try {
            this._gtag(...args.filter(x => x !== undefined));
        }
        catch (err) {
            this.throw(err);
        }
    }
    /**
     * Send an event trigger to GA. It is the same as call:
     * ```js
     * gtag('event', 'video_auto_play_start', {
     *   'event_label': 'My promotional video',
     *   'event_category': 'video_auto_play'
     * });
     * ```
     *
     * @param action 'video_auto_play_start'
     * @param category 'video_auto_play'
     * @param label 'My promotional video'
     * @param value An value to measure something
     */
    event(action, category, label, value, interaction) {
        try {
            const opt = new Map();
            if (category) {
                opt.set('event_category', category);
            }
            if (label) {
                opt.set('event_label', label);
            }
            if (value) {
                opt.set('value', value);
            }
            if (interaction !== undefined) {
                opt.set('interaction', interaction);
            }
            const params = this.toKeyValue(opt);
            if (params) {
                this.gtag('event', action, params);
            }
            else {
                this.gtag('event', action);
            }
        }
        catch (error) {
            this.throw(error);
        }
    }
    /**
     * Send an page view event. This is the same as
     *
     * ```js
     * gtag('config', 'GA_TRACKING_ID', {
     *   'page_title' : 'Homepage',
     *   'page_path': '/home'
     * });
     * ```
     *
     * The tracking ID is injected automatically by Inject Token NGX_GOOGLE_ANALYTICS_SETTINGS_TOKEN
     *
     * @param path /home
     * @param title Homepage
     * @param location '{ page_location }'
     * @param options '{ ... custom dimentions }'
     */
    pageView(path, title, location, options) {
        try {
            const opt = new Map([['page_path', path]]);
            if (title) {
                opt.set('page_title', title);
            }
            if (location || this.document) {
                opt.set('page_location', (location || this.document.location.href));
            }
            if (options) {
                Object
                    .entries(options)
                    .map(([key, value]) => opt.set(key, value));
            }
            this.gtag('config', this.settings.trackingCode, this.toKeyValue(opt));
        }
        catch (error) {
            this.throw(error);
        }
    }
    /**
     * Send an event to report a App Page View. It is the same as
     *
     * ```js
     * gtag('event', 'screen_view', {
     *   'app_name': 'myAppName',
     *   'screen_name' : 'Home'
     * });
     *
     * ```
     *
     * @param screen 'screen_name'
     * @param appName 'app_name'
     * @param appId 'app_id'
     * @param appVersion 'app_version'
     * @param installerId 'app_installer_id'
     */
    appView(screen, appName, appId, appVersion, installerId) {
        try {
            const opt = new Map([['screen_name', screen], ['app_name', appName]]);
            if (appId) {
                opt.set('app_id', appId);
            }
            if (appVersion) {
                opt.set('app_version', appVersion);
            }
            if (installerId) {
                opt.set('app_installer_id', installerId);
            }
            this.gtag('event', 'screen_view', this.toKeyValue(opt));
        }
        catch (error) {
            this.throw(error);
        }
    }
    /**
     * Defines persistent values on GoogleAnalytics
     *
     * @see https://developers.google.com/analytics/devguides/collection/gtagjs/setting-values
     *
     * ```js
     * gtag('set', {
     *   'currency': 'USD',
     *   'country': 'US'
     * });
     * ```
     */
    set(...options) {
        try {
            this._gtag('set', ...options);
        }
        catch (err) {
            this.throw(err);
        }
    }
    /**
     * Send an event to GA to report an application error. It is the same as
     *
     * ```js
     * gtag('event', 'exception', {
     *   'description': 'error_description',
     *   'fatal': false   // set to true if the error is fatal
     * });
     * ```
     *
     * @param description 'error_description'
     * @param fatal set to true if the error is fatal
     */
    exception(description, fatal) {
        try {
            const opt = new Map();
            if (description) {
                opt.set('description', description);
            }
            if (fatal) {
                opt.set('fatal', fatal);
            }
            const params = this.toKeyValue(opt);
            if (params) {
                this.gtag('event', 'exception', this.toKeyValue(opt));
            }
            else {
                this.gtag('event', 'exception');
            }
        }
        catch (error) {
            this.throw(error);
        }
    }
}
GoogleAnalyticsService.ɵfac = function GoogleAnalyticsService_Factory(t) { return new (t || GoogleAnalyticsService)(ɵngcc0.ɵɵinject(NGX_GOOGLE_ANALYTICS_SETTINGS_TOKEN), ɵngcc0.ɵɵinject(DOCUMENT), ɵngcc0.ɵɵinject(NGX_GTAG_FN)); };
GoogleAnalyticsService.ɵprov = i0.ɵɵdefineInjectable({ factory: function GoogleAnalyticsService_Factory() { return new GoogleAnalyticsService(i0.ɵɵinject(i1.NGX_GOOGLE_ANALYTICS_SETTINGS_TOKEN), i0.ɵɵinject(i2.DOCUMENT), i0.ɵɵinject(i3.NGX_GTAG_FN)); }, token: GoogleAnalyticsService, providedIn: "root" });
GoogleAnalyticsService.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Inject, args: [NGX_GOOGLE_ANALYTICS_SETTINGS_TOKEN,] }] },
    { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] },
    { type: undefined, decorators: [{ type: Inject, args: [NGX_GTAG_FN,] }] }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(GoogleAnalyticsService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: undefined, decorators: [{
                type: Inject,
                args: [NGX_GOOGLE_ANALYTICS_SETTINGS_TOKEN]
            }] }, { type: undefined, decorators: [{
                type: Inject,
                args: [DOCUMENT]
            }] }, { type: undefined, decorators: [{
                type: Inject,
                args: [NGX_GTAG_FN]
            }] }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ29vZ2xlLWFuYWx5dGljcy5zZXJ2aWNlLmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi9wcm9qZWN0cy9uZ3gtZ29vZ2xlLWFuYWx5dGljcy9zcmMvbGliL3NlcnZpY2VzL2dvb2dsZS1hbmFseXRpY3Muc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDOUQsT0FBTyxFQUFFLG1DQUFtQyxFQUFFLE1BQU0sK0NBQStDLENBQUM7QUFHcEcsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUN2RDtBQUFxQztBQUtmO0FBRUE7O0FBRnRCLE1BQU0sT0FBTyxzQkFBc0I7QUFDbkMsSUFLRSxZQUNnRSxRQUFrQyxFQUM3RCxTQUFjLEVBQ1gsS0FBYTtBQUNwRCxRQUgrRCxhQUFRLEdBQVIsUUFBUSxDQUEwQjtBQUFDLFFBQzlELGNBQVMsR0FBVCxTQUFTLENBQUs7QUFBQyxRQUNaLFVBQUssR0FBTCxLQUFLLENBQVE7QUFDdkQsSUFBTSxDQUFDO0FBQ1AsSUFURSxJQUFZLFFBQVE7QUFBSyxRQUN2QixPQUFPLElBQUksQ0FBQyxTQUFTLENBQUM7QUFDMUIsSUFBRSxDQUFDO0FBQ0gsSUFPVSxLQUFLLENBQUMsR0FBVTtBQUMxQixRQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLGFBQWEsSUFBSSxTQUFTLEVBQUUsQ0FBQyxJQUFJLE9BQU8sSUFBSSxPQUFPLENBQUMsS0FBSyxFQUFFO0FBQ2xGLFlBQU0sT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUN6QixTQUFLO0FBQ0wsSUFBRSxDQUFDO0FBQ0gsSUFDRSxrRUFBa0U7QUFDcEUsSUFBVSxVQUFVLENBQUMsR0FBcUI7QUFBSSxRQUMxQyxPQUFPLENBQUMsR0FB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QUFDLFdBQW9CLEVBQUUsS0FBZTtBQUNqRCxRQUFJLElBQUk7QUFDUixZQUFNLE1BQU0sR0FBRyxHQUFHLElBQUksR0FBRyxFQUFlLENBQUM7QUFDekMsWUFBTSxJQUFJLFdBQVcsRUFBRTtBQUN2QixnQkFBUSxHQUFHLENBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRSxXQUFXLENBQUMsQ0FBQztBQUM1QyxhQUFPO0FBQ1AsWUFBTSxJQUFJLEtBQUssRUFBRTtBQUNqQixnQkFBUSxHQUFHLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQztBQUNoQyxhQUFPO0FBQ1AsWUFBTSxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQzFDLFlBQU0sSUFBSSxNQUFNLEVBQUU7QUFDbEIsZ0JBQVEsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsV0FBVyxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztBQUM5RCxhQUFPO0FBQUMsaUJBQUs7QUFDYixnQkFBUSxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxXQUFXLENBQUMsQ0FBQztBQUN4QyxhQUFPO0FBQ1AsU0FBSztBQUFDLFFBQUEsT0FBTyxLQUFLLEVBQUU7QUFDcEIsWUFBTSxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQ3hCLFNBQUs7QUFDTCxJQUFFLENBQUM7QUFDSDtzT0FBQztBQUNELG1UQTVNSztBQUFDO0VBSEwsVUFBVSxTQUFDLGtCQUNWLFVBQVUsRUFBRSxNQUFNLGNBQ25CLHZFQUdjLDRDQUtWLE1BQU0sU0FBQyxtQ0FBbUM7QUFBUyw0Q0FDbkQsTUFBTSxTQUFDLFFBQVE7QUFBUyw0Q0FDeEIsTUFBTSxTQUFDLFdBQVc7QUFBUTs7Ozs7Ozs7Ozs7Ozs7O2tDQUFFO0FBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3QsIGlzRGV2TW9kZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgTkdYX0dPT0dMRV9BTkFMWVRJQ1NfU0VUVElOR1NfVE9LRU4gfSBmcm9tICcuLi90b2tlbnMvbmd4LWdvb2dsZS1hbmFseXRpY3Mtc2V0dGluZ3MtdG9rZW4nO1xuaW1wb3J0IHsgSUdvb2dsZUFuYWx5dGljc1NldHRpbmdzIH0gZnJvbSAnLi4vaW50ZXJmYWNlcy9pLWdvb2dsZS1hbmFseXRpY3Mtc2V0dGluZ3MnO1xuaW1wb3J0IHsgR2FBY3Rpb25FbnVtIH0gZnJvbSAnLi4vZW51bXMvZ2EtYWN0aW9uLmVudW0nO1xuaW1wb3J0IHsgRE9DVU1FTlQgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHsgTkdYX0dUQUdfRk4gfSBmcm9tICcuLi90b2tlbnMvbmd4LWd0YWctdG9rZW4nO1xuaW1wb3J0IHsgR3RhZ0ZuIH0gZnJvbSAnLi4vdHlwZXMvZ3RhZy50eXBlJztcblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgR29vZ2xlQW5hbHl0aWNzU2VydmljZSB7XG5cbiAgcHJpdmF0ZSBnZXQgZG9jdW1lbnQoKTogRG9jdW1lbnQge1xuICAgIHJldHVybiB0aGlzLl9kb2N1bWVudDtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIEBJbmplY3QoTkdYX0dPT0dMRV9BTkFMWVRJQ1NfU0VUVElOR1NfVE9LRU4pIHByaXZhdGUgcmVhZG9ubHkgc2V0dGluZ3M6IElHb29nbGVBbmFseXRpY3NTZXR0aW5ncyxcbiAgICBASW5qZWN0KERPQ1VNRU5UKSBwcml2YXRlIHJlYWRvbmx5IF9kb2N1bWVudDogYW55LFxuICAgIEBJbmplY3QoTkdYX0dUQUdfRk4pIHByaXZhdGUgcmVhZG9ubHkgX2d0YWc6IEd0YWdGblxuICApIHsgfVxuXG4gIHByaXZhdGUgdGhyb3coZXJyOiBFcnJvcikge1xuICAgIGlmICgodGhpcy5zZXR0aW5ncy5lbmFibGVUcmFjaW5nIHx8IGlzRGV2TW9kZSgpKSAmJiBjb25zb2xlICYmIGNvbnNvbGUuZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoZXJyKTtcbiAgICB9XG4gIH1cblxuICAvKiogQHRvZG8gQ2hhbmdlIHRoaXMgdG8gYE9iamVjdC5mcm9tRW50aXR5KClgIGluIHRoZSBmdXR1cmUuLi4gKi9cbiAgcHJpdmF0ZSB0b0tleVZhbHVlKG1hcDogTWFwPHN0cmluZywgYW55Pik6IHsgW3BhcmFtOiBzdHJpbmddOiBhbnkgfSB8IHZvaWQge1xuICAgIHJldHVybiAobWFwLnNpemUgPiAwKVxuICAgICAgPyBBcnJheS5mcm9tKG1hcCkucmVkdWNlKFxuICAgICAgICAob2JqLCBba2V5LCB2YWx1ZV0pID0+IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvYmosIGtleSwgeyB2YWx1ZSwgZW51bWVyYWJsZTogdHJ1ZSB9KSxcbiAgICAgICAge31cbiAgICAgIClcbiAgICAgIDogdW5kZWZpbmVkO1xuICB9XG5cbiAgLyoqXG4gICAqIENhbGwgbmF0aXZlIEdBIFRhZ1xuICAgKi9cbiAgZ3RhZyguLi5hcmdzOiBhbnlbXSkge1xuICAgIHRyeSB7XG4gICAgICB0aGlzLl9ndGFnKC4uLmFyZ3MuZmlsdGVyKHggPT4geCAhPT0gdW5kZWZpbmVkKSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICB0aGlzLnRocm93KGVycik7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFNlbmQgYW4gZXZlbnQgdHJpZ2dlciB0byBHQS4gSXQgaXMgdGhlIHNhbWUgYXMgY2FsbDpcbiAgICogYGBganNcbiAgICogZ3RhZygnZXZlbnQnLCAndmlkZW9fYXV0b19wbGF5X3N0YXJ0Jywge1xuICAgKiAgICdldmVudF9sYWJlbCc6ICdNeSBwcm9tb3Rpb25hbCB2aWRlbycsXG4gICAqICAgJ2V2ZW50X2NhdGVnb3J5JzogJ3ZpZGVvX2F1dG9fcGxheSdcbiAgICogfSk7XG4gICAqIGBgYFxuICAgKlxuICAgKiBAcGFyYW0gYWN0aW9uICd2aWRlb19hdXRvX3BsYXlfc3RhcnQnXG4gICAqIEBwYXJhbSBjYXRlZ29yeSAndmlkZW9fYXV0b19wbGF5J1xuICAgKiBAcGFyYW0gbGFiZWwgJ015IHByb21vdGlvbmFsIHZpZGVvJ1xuICAgKiBAcGFyYW0gdmFsdWUgQW4gdmFsdWUgdG8gbWVhc3VyZSBzb21ldGhpbmdcbiAgICovXG4gIGV2ZW50KGFjdGlvbjogR2FBY3Rpb25FbnVtIHwgc3RyaW5nLCBjYXRlZ29yeT86IHN0cmluZywgbGFiZWw/OiBzdHJpbmcsIHZhbHVlPzogbnVtYmVyLCBpbnRlcmFjdGlvbj86IGJvb2xlYW4pIHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qgb3B0ID0gbmV3IE1hcDxzdHJpbmcsIGFueT4oKTtcbiAgICAgIGlmIChjYXRlZ29yeSkge1xuICAgICAgICBvcHQuc2V0KCdldmVudF9jYXRlZ29yeScsIGNhdGVnb3J5KTtcbiAgICAgIH1cbiAgICAgIGlmIChsYWJlbCkge1xuICAgICAgICBvcHQuc2V0KCdldmVudF9sYWJlbCcsIGxhYmVsKTtcbiAgICAgIH1cbiAgICAgIGlmICh2YWx1ZSkge1xuICAgICAgICBvcHQuc2V0KCd2YWx1ZScsIHZhbHVlKTtcbiAgICAgIH1cbiAgICAgIGlmIChpbnRlcmFjdGlvbiAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIG9wdC5zZXQoJ2ludGVyYWN0aW9uJywgaW50ZXJhY3Rpb24pO1xuICAgICAgfVxuICAgICAgY29uc3QgcGFyYW1zID0gdGhpcy50b0tleVZhbHVlKG9wdCk7XG4gICAgICBpZiAocGFyYW1zKSB7XG4gICAgICAgIHRoaXMuZ3RhZygnZXZlbnQnLCBhY3Rpb24gYXMgc3RyaW5nLCBwYXJhbXMpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5ndGFnKCdldmVudCcsIGFjdGlvbiBhcyBzdHJpbmcpO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLnRocm93KGVycm9yKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogU2VuZCBhbiBwYWdlIHZpZXcgZXZlbnQuIFRoaXMgaXMgdGhlIHNhbWUgYXNcbiAgICpcbiAgICogYGBganNcbiAgICogZ3RhZygnY29uZmlnJywgJ0dBX1RSQUNLSU5HX0lEJywge1xuICAgKiAgICdwYWdlX3RpdGxlJyA6ICdIb21lcGFnZScsXG4gICAqICAgJ3BhZ2VfcGF0aCc6ICcvaG9tZSdcbiAgICogfSk7XG4gICAqIGBgYFxuICAgKlxuICAgKiBUaGUgdHJhY2tpbmcgSUQgaXMgaW5qZWN0ZWQgYXV0b21hdGljYWxseSBieSBJbmplY3QgVG9rZW4gTkdYX0dPT0dMRV9BTkFMWVRJQ1NfU0VUVElOR1NfVE9LRU5cbiAgICpcbiAgICogQHBhcmFtIHBhdGggL2hvbWVcbiAgICogQHBhcmFtIHRpdGxlIEhvbWVwYWdlXG4gICAqIEBwYXJhbSBsb2NhdGlvbiAneyBwYWdlX2xvY2F0aW9uIH0nXG4gICAqIEBwYXJhbSBvcHRpb25zICd7IC4uLiBjdXN0b20gZGltZW50aW9ucyB9J1xuICAgKi9cbiAgcGFnZVZpZXcoIHBhdGg6IHN0cmluZywgdGl0bGU/OiBzdHJpbmcsIGxvY2F0aW9uPzogc3RyaW5nLCBvcHRpb25zPzogT2JqZWN0KSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IG9wdCA9IG5ldyBNYXA8c3RyaW5nLCBhbnk+KFtbJ3BhZ2VfcGF0aCcsIHBhdGhdXSk7XG4gICAgICBpZiAodGl0bGUpIHtcbiAgICAgICAgb3B0LnNldCgncGFnZV90aXRsZScsIHRpdGxlKTtcbiAgICAgIH1cbiAgICAgIGlmIChsb2NhdGlvbiB8fCB0aGlzLmRvY3VtZW50KSB7XG4gICAgICAgIG9wdC5zZXQoJ3BhZ2VfbG9jYXRpb24nLCAobG9jYXRpb24gfHwgdGhpcy5kb2N1bWVudC5sb2NhdGlvbi5ocmVmKSk7XG4gICAgICB9XG4gICAgICBpZiAob3B0aW9ucykge1xuICAgICAgICBPYmplY3RcbiAgICAgICAgICAuZW50cmllcyhvcHRpb25zKVxuICAgICAgICAgIC5tYXAoKFtrZXksIHZhbHVlXSkgPT4gb3B0LnNldChrZXksIHZhbHVlKSk7XG4gICAgICB9XG4gICAgICB0aGlzLmd0YWcoJ2NvbmZpZycsIHRoaXMuc2V0dGluZ3MudHJhY2tpbmdDb2RlLCB0aGlzLnRvS2V5VmFsdWUob3B0KSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMudGhyb3coZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBTZW5kIGFuIGV2ZW50IHRvIHJlcG9ydCBhIEFwcCBQYWdlIFZpZXcuIEl0IGlzIHRoZSBzYW1lIGFzXG4gICAqXG4gICAqIGBgYGpzXG4gICAqIGd0YWcoJ2V2ZW50JywgJ3NjcmVlbl92aWV3Jywge1xuICAgKiAgICdhcHBfbmFtZSc6ICdteUFwcE5hbWUnLFxuICAgKiAgICdzY3JlZW5fbmFtZScgOiAnSG9tZSdcbiAgICogfSk7XG4gICAqXG4gICAqIGBgYFxuICAgKlxuICAgKiBAcGFyYW0gc2NyZWVuICdzY3JlZW5fbmFtZSdcbiAgICogQHBhcmFtIGFwcE5hbWUgJ2FwcF9uYW1lJ1xuICAgKiBAcGFyYW0gYXBwSWQgJ2FwcF9pZCdcbiAgICogQHBhcmFtIGFwcFZlcnNpb24gJ2FwcF92ZXJzaW9uJ1xuICAgKiBAcGFyYW0gaW5zdGFsbGVySWQgJ2FwcF9pbnN0YWxsZXJfaWQnXG4gICAqL1xuICBhcHBWaWV3KHNjcmVlbjogc3RyaW5nLCBhcHBOYW1lOiBzdHJpbmcsIGFwcElkPzogc3RyaW5nLCBhcHBWZXJzaW9uPzogc3RyaW5nLCBpbnN0YWxsZXJJZD86IHN0cmluZykge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBvcHQgPSBuZXcgTWFwPHN0cmluZywgYW55PihbWydzY3JlZW5fbmFtZScsIHNjcmVlbl0sIFsnYXBwX25hbWUnLCBhcHBOYW1lXV0pO1xuICAgICAgaWYgKGFwcElkKSB7XG4gICAgICAgIG9wdC5zZXQoJ2FwcF9pZCcsIGFwcElkKTtcbiAgICAgIH1cbiAgICAgIGlmIChhcHBWZXJzaW9uKSB7XG4gICAgICAgIG9wdC5zZXQoJ2FwcF92ZXJzaW9uJywgYXBwVmVyc2lvbik7XG4gICAgICB9XG4gICAgICBpZiAoaW5zdGFsbGVySWQpIHtcbiAgICAgICAgb3B0LnNldCgnYXBwX2luc3RhbGxlcl9pZCcsIGluc3RhbGxlcklkKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuZ3RhZygnZXZlbnQnLCAnc2NyZWVuX3ZpZXcnLCB0aGlzLnRvS2V5VmFsdWUob3B0KSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMudGhyb3coZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBEZWZpbmVzIHBlcnNpc3RlbnQgdmFsdWVzIG9uIEdvb2dsZUFuYWx5dGljc1xuICAgKlxuICAgKiBAc2VlIGh0dHBzOi8vZGV2ZWxvcGVycy5nb29nbGUuY29tL2FuYWx5dGljcy9kZXZndWlkZXMvY29sbGVjdGlvbi9ndGFnanMvc2V0dGluZy12YWx1ZXNcbiAgICpcbiAgICogYGBganNcbiAgICogZ3RhZygnc2V0Jywge1xuICAgKiAgICdjdXJyZW5jeSc6ICdVU0QnLFxuICAgKiAgICdjb3VudHJ5JzogJ1VTJ1xuICAgKiB9KTtcbiAgICogYGBgXG4gICAqL1xuICBzZXQoLi4ub3B0aW9uczogQXJyYXk8YW55Pikge1xuICAgIHRyeSB7XG4gICAgICB0aGlzLl9ndGFnKCdzZXQnLCAuLi5vcHRpb25zKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHRoaXMudGhyb3coZXJyKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogU2VuZCBhbiBldmVudCB0byBHQSB0byByZXBvcnQgYW4gYXBwbGljYXRpb24gZXJyb3IuIEl0IGlzIHRoZSBzYW1lIGFzXG4gICAqXG4gICAqIGBgYGpzXG4gICAqIGd0YWcoJ2V2ZW50JywgJ2V4Y2VwdGlvbicsIHtcbiAgICogICAnZGVzY3JpcHRpb24nOiAnZXJyb3JfZGVzY3JpcHRpb24nLFxuICAgKiAgICdmYXRhbCc6IGZhbHNlICAgLy8gc2V0IHRvIHRydWUgaWYgdGhlIGVycm9yIGlzIGZhdGFsXG4gICAqIH0pO1xuICAgKiBgYGBcbiAgICpcbiAgICogQHBhcmFtIGRlc2NyaXB0aW9uICdlcnJvcl9kZXNjcmlwdGlvbidcbiAgICogQHBhcmFtIGZhdGFsIHNldCB0byB0cnVlIGlmIHRoZSBlcnJvciBpcyBmYXRhbFxuICAgKi9cbiAgZXhjZXB0aW9uKGRlc2NyaXB0aW9uPzogc3RyaW5nLCBmYXRhbD86IGJvb2xlYW4pIHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qgb3B0ID0gbmV3IE1hcDxzdHJpbmcsIGFueT4oKTtcbiAgICAgIGlmIChkZXNjcmlwdGlvbikge1xuICAgICAgICBvcHQuc2V0KCdkZXNjcmlwdGlvbicsIGRlc2NyaXB0aW9uKTtcbiAgICAgIH1cbiAgICAgIGlmIChmYXRhbCkge1xuICAgICAgICBvcHQuc2V0KCdmYXRhbCcsIGZhdGFsKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IHBhcmFtcyA9IHRoaXMudG9LZXlWYWx1ZShvcHQpO1xuICAgICAgaWYgKHBhcmFtcykge1xuICAgICAgICB0aGlzLmd0YWcoJ2V2ZW50JywgJ2V4Y2VwdGlvbicsIHRoaXMudG9LZXlWYWx1ZShvcHQpKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuZ3RhZygnZXZlbnQnLCAnZXhjZXB0aW9uJyk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMudGhyb3coZXJyb3IpO1xuICAgIH1cbiAgfVxufVxuIl19